___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "EBOD Purchase Tracking Script",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Essential prerequisite for tracking your online data with EBOD application.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "tokenId",
    "displayName": "Website Token key",
    "simpleValueType": true,
    "notSetText": "Token must be set",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "email",
    "displayName": "Purchase email address",
    "simpleValueType": true,
    "help": "Purchase email address",
    "notSetText": "Purchase email address must be set",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "externalId",
    "displayName": "Purchase ID or External ID",
    "simpleValueType": true,
    "notSetText": "External ID must be set",
    "help": "",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "currency",
    "displayName": "[optional] Purchase Currency code",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "totalPrice",
    "displayName": "[optional] Purchase total price",
    "simpleValueType": true
  },
  {
    "type": "CHECKBOX",
    "name": "debug",
    "checkboxText": "Log debug messages to console",
    "simpleValueType": true,
    "defaultValue": ""
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Require the necessary APIs
const logToConsole = require('logToConsole');
const injectScript = require('injectScript');
const callInWindow = require('callInWindow');
const setInWindow = require('setInWindow');
const queryPermission = require('queryPermission');

// Get the URL the user input into the text field
const url = 'https://e.bod.digital/init.js?v=3007';
const token = data.tokenId;

// If the user chose to log debug output, initialize the logging method
const log = data.debug ? logToConsole : (() => {});

log('[EBOD] Email: ' + data.email + ', ExternalId: ' + data.externalId);
log('[EBOD] Loading script from ' + url + ', Token: ' + token);

// If the script loaded successfully, log a message and signal success
const onSuccess = () => {
  log('[EBOD] Script loaded successfully.');
  callInWindow('Ebod.init', token);
  callInWindow('Ebod.purchase', {
    event: 'ebod_purchase',
    email: data.email,
    externalId: data.externalId,
    currency: data.currency || '',
    totalPrice: data.totalPrice || ''
  });
  data.gtmOnSuccess();
};

// If the script fails to load, log a message and signal failure
const onFailure = () => {
  log('[EBOD] Script load failed.');
  data.gtmOnFailure();
};

// If the URL input by the user matches the permissions set for the template,
// inject the script with the onSuccess and onFailure methods as callbacks.
if (queryPermission('inject_script', url)) {
  injectScript(url, onSuccess, onFailure);
} else {
  log('[EBOD] Script load failed due to permissions mismatch.');
  data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.bod.digital/"
              },
              {
                "type": 1,
                "string": "https://bod.digital/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "Ebod"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "Ebod.init"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "Ebod.purchase"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Test
  code: |-
    const mockData = {
      email: 'test@example.com',
      externalId: 123,
      tokenId: 'test'
    };
    runCode(mockData);
    assertApi('gtmOnFailure').wasNotCalled();


___NOTES___

Created on 30. 7. 2023 15:09:53


